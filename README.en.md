# Codex Windows Repack Toolkit

[中文](README.md) | English

A toolkit for repackaging `Codex.dmg` (macOS packaged artifact) into a Windows installer (NSIS `.exe`).

Default DMG download link:

`https://persistent.oaistatic.com/codex-app-prod/Codex.dmg`

## Directory Structure

```text
codexapp-windows-rebuild/
  .github/workflows/repack-windows.yml
  scripts/repack.mjs
  scripts/helpers.mjs
  run.ps1
  package.json
  Codex.dmg                 # Default local DMG location
  release/                  # Build output directory
  work/                     # Temporary directory (cleared on each build)
```

## Prerequisites

- Windows 10/11 x64
- Node.js 22 (LTS recommended) and npm
- Visual Studio Build Tools (C++ toolchain) if native module compilation fails locally
- For GitHub Actions Release publishing, repository must allow workflow write access to `contents`

## Local Build

Execute in the `codexapp-windows-rebuild` directory.

1. Install dependencies

```powershell
npm ci
```

2. Default build

```powershell
npm run repack
```

Default behavior:

- If `Codex.dmg` exists in the project root, it will be used first
- If not found, DMG will be downloaded from the default link
- Automatically patches to disable `appSunset` forced upgrade page (prevents startup update prompts)
- Automatically generates Windows `app.ico` from DMG's `Contents/Resources/electron.icns` for app/installer icons
- If old icons persist in taskbar/start menu after reinstall, it's usually due to Windows icon cache; restart Explorer to refresh

3. Specify DMG download URL

```powershell
npm run repack -- --dmg-url "https://persistent.oaistatic.com/codex-app-prod/Codex.dmg"
```

4. Specify local DMG file

```powershell
npm run repack -- --dmg-file "D:\path\Codex.dmg"
```

5. Optional: Override Electron version

```powershell
npm run repack -- --dmg-file "D:\path\Codex.dmg" --electron-version "40.0.0"
```

6. PowerShell entry script

```powershell
.\run.ps1
.\run.ps1 -DmgUrl "https://persistent.oaistatic.com/codex-app-prod/Codex.dmg"
.\run.ps1 -DmgFile "D:\path\Codex.dmg"
.\run.ps1 -DmgFile "D:\path\Codex.dmg" -ElectronVersion "40.0.0"
```

`.\run.ps1` also prioritizes using `Codex.dmg` in the current directory by default.

## Output Description

Build output is located in `release/`:

- `Codex-Setup-<version>.exe`: Windows installer
- `*.blockmap`: Incremental update files generated by electron-builder
- `build-metadata.json`: Build metadata including:
  - `version`
  - `electronVersion`
  - `sourceDmgUrl`
  - `sourceDmgFile`
  - `installerFile`
  - `installerName`
  - `sha256`
  - `sunsetPatchApplied`
  - `sunsetPatchedFile`

## GitHub Actions Auto Build/Release

Workflow file: `.github/workflows/repack-windows.yml`

### Trigger Method

1. Open GitHub repository `Actions`
2. Select `Repack Codex Windows`
3. Click `Run workflow`
4. Fill in parameters

Parameters:

- `dmg_url`: DMG download URL
- `publish_release`: Automatically publish GitHub Release when set to `true`
- Tag is automatically generated based on build version: `codex-win-v<version>`

### Artifact Location

- Actions Artifact: `.exe`, `.blockmap`, `build-metadata.json`
- When `publish_release=true`, these files are attached to GitHub Release

## Path Considerations

The current workflow automatically recognizes two repository structures:

- Repository root is the tool directory (with `package.json` at root)
- Repository root contains `codexapp-windows-rebuild/` subdirectory

No need to manually modify `working-directory`.
